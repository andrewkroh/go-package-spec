# go-package-spec

Go data model and reader for Elastic [package-spec](https://github.com/andrewkroh/package-spec-schema) packages.

## Design goals

- The data model (`pkgspec`) can be used independently of the reader (`pkgreader`).
- The reader accepts a package directory and options (Go functional options pattern), reads all package contents into data model types, and annotates them with file metadata.
- Goal is native-format unmarshaling (YAML/JSON). Round-trip marshaling and preserving exact file format is explicitly a non-goal.
- `WithKnownFields()` enables strict validation where only fields defined in the model types are allowed (delegates to the YAML/JSON decoder). Off by default for forward compatibility.
- `WithGitMetadata()` enriches types using git — commit ID for the package, and git blame on the changelog to determine release dates. Prior art: `github.com/andrewkroh/go-fleetpkg`.
- `FlattenFields` flattens dotted field names and enriches ECS fields using `github.com/andrewkroh/go-ecs`. Prior art: `FlattenFields` in `github.com/andrewkroh/go-fleetpkg`.

## Project layout

```
cmd/generate/
  main.go                      CLI entry point for code generator
  augment.yml                  Type/field augmentation config
  filemap.yml                  Type -> output file mapping
  internal/generator/          Code generation pipeline
    augment.go                 Type/field overrides + extra_fields + base_types
    emitter.go                 Go source emission via dave/jennifer/jen
    filemap.go                 Maps types to output files
    generator.go               Orchestrator (Run pipeline)
    loader.go                  JSON Schema parser + $ref resolution
    naming.go                  Go identifier conventions
    typemap.go                 JSON Schema -> GoType conversion
pkgspec/                   Generated data model (DO NOT EDIT except hand-written files below)
  annotation.go                Hand-written: exports AnnotateFileMetadata
  processor.go                 Hand-written: Processor type with custom marshal/unmarshal
  stringorstrings.go           Hand-written: StringOrStrings type for anyOf [string, []string]
  flatten.go                   Hand-written: FlattenFields with ECS enrichment callback
  manifesttype.go              Hand-written: ManifestType enum (integration/input/content)
  metadata.go                  Generated: FileMetadata type + reflection walker
  manifest.go                  Manifest base type + Integration/Input/Content manifests
  build.go                     Generated: BuildManifest type for _dev/build/build.yml
  test.go                      Generated: Test config types (TestConfig, SystemTestConfig, etc.)
  ingest_pipeline.go           Generated: IngestPipeline type
  routing_rules.go             Generated: RoutingRuleSet, RoutingRule types
  version.go                   Generated: SpecVersion constant (package-spec schema version)
  *.go                         Other generated types (changelog, field, transform, etc.)
pkgreader/                        Package reader (loads from disk into pkgspec types)
  reader.go                    Read() entry point, Package type, options
  decode.go                    YAML decoding helpers
  datastream.go                DataStream + FieldsFile + PipelineFile types
  doc.go                       DocFile type + readDocs() for docs/ discovery
  test.go                      DataStreamTests, PipelineTestCase, InputPackageTests + loading
  transform.go                 TransformData type
  git.go                       Git commit + git blame for changelog dates
cmd/gensql/
  main.go                      CLI entry point for SQL generator
  tables.yml                   Table → type mapping config
  internal/sqlgen/             SQL generation pipeline
    config.go                  tables.yml loader
    registry.go                Type name → reflect.Type registry
    reflect.go                 Struct field → SQL column walker
    naming.go                  Go → SQL name conversion
    sort.go                    Topological sort by FK dependencies
    schema.go                  schema.sql emitter
    query.go                   query.sql emitter
    emitter.go                 tables.go + insert.go emitter (jennifer/jen)
    generator.go               Orchestrator (Run pipeline)
pkgsql/                        SQL interface for loading packages into SQLite
  internal/db/                 Generated sqlc output (hidden from consumers)
    sqlc.yaml                  sqlc configuration (package db)
    schema.sql                 Generated: CREATE TABLE statements
    query.sql                  Generated: INSERT queries for sqlc
    db.go                      Generated by sqlc: DBTX interface, Queries
    models.go                  Generated by sqlc: InsertXParams structs
    query.sql.go               Generated by sqlc: Insert methods
  tables.go                    Generated: unexported table constants + creates slice
  insert.go                    Generated: Type → db.InsertXParams param mapping
  api.go                       Hand-written: WritePackages/WritePackage/TableSchemas
  fts.go                       Hand-written: FTS5 virtual table schema + RebuildDocsFTS
  api_test.go                  Hand-written: Integration tests
  doc.go                       Hand-written: go:generate directives
```

## Code generation

### Running the generator

```sh
go run ./cmd/generate/ \
  -schema-dir ../package-spec-schema/3.5.7/jsonschema \
  -augment cmd/generate/augment.yml \
  -filemap cmd/generate/filemap.yml \
  -output pkgspec \
  -package pkgspec \
  -spec-version 3.5.7  # optional; auto-detected from schema $id if omitted
```

All files in `pkgspec/` except `annotation.go` and `processor.go` are generated. Never hand-edit them.

### Generator pipeline

1. Load JSON schemas from `-schema-dir` via `SchemaRegistry`
2. Convert to Go types via `TypeMapper` (handles $ref, allOf, if/then/else, enums)
3. `ApplyAugmentations` — renames, doc overrides, field type overrides, extra fields
4. `ApplyBaseTypes` — extracts common fields into shared base types (e.g. `Manifest`)
5. Assign output files via `FileMap`
6. Validate (enum collision check)
7. Emit Go files via `Emitter` (jennifer/jen)

### augment.yml features

- **Type overrides**: rename types, override docs, override field types/names/docs
- **`extra_fields`**: inject fields not in the schema (e.g. `Changelog.Date *time.Time`)
- **`base_types`**: extract common fields from multiple types into a shared base type with embedding (e.g. `Manifest` from Integration/Input/ContentManifest)

### Key design decisions

- **FileMetadata embedding**: Entry-point types embed `FileMetadata` to track source file/line/column. The `UnmarshalYAML` method uses a type-alias trick to capture YAML node position without infinite recursion.
- **Base type YAML workaround**: go-yaml's type-alias trick doesn't populate promoted fields from Go embeds. The emitter generates a second `node.Decode(&v.BaseType)` call for types embedding a base type.
- **Base types don't get UnmarshalYAML**: Only concrete types (IntegrationManifest, etc.) have UnmarshalYAML. The base type (Manifest) embeds FileMetadata but has no UnmarshalYAML to avoid conflicts.
- **Required vs optional**: Required fields use bare struct tags (`json:"name"`), optional fields use `omitempty` (`json:"title,omitempty"`). Only optional booleans use pointer types (`*bool`).
- **Qualified types**: `parseTypeRef` handles `pkg.Type` patterns (e.g. `time.Time`) via `GoTypeRef.Package`/`QualName`, emitted as `jen.Qual()`.

## SQL generator

### Running the SQL generator

```sh
go run ./cmd/gensql/ \
  -tables cmd/gensql/tables.yml \
  -output pkgsql \
  -package pkgsql
```

This writes `tables.go` and `insert.go` to `-output`, and `schema.sql` + `query.sql` to `<output>/internal/db/` (override with `-sql-output`).

Then run sqlc to generate the type-safe database bindings:

```sh
go run github.com/sqlc-dev/sqlc/cmd/sqlc@v1.29.0 generate -f pkgsql/internal/db/sqlc.yaml
```

Both steps are automated via `go generate ./pkgsql/`.

### How tables.yml drives schema generation

`tables.yml` defines each SQL table and maps it to a pkgspec Go type. The generator uses reflection to walk struct fields and produce SQL columns. Key config options per table:

- **`type`**: pkgspec type name (looked up in `cmd/gensql/internal/sqlgen/registry.go`)
- **`parent`**: parent table name (adds FK column automatically)
- **`inline`**: list of struct fields to expand into separate columns (e.g. `Owner.Github` → `owner_github`)
- **`json_columns`**: list of struct fields stored as a single JSON TEXT column
- **`exclude`**: list of struct fields to skip
- **`extra_columns`**: columns not derived from the Go type (e.g. `dir_name` on data_streams)
- **`columns`**: per-column overrides (comment, unique, not_null)

### SQL generator pipeline

1. Load `tables.yml` config
2. For each table with a `type`, resolve the Go type via registry and walk its struct fields
3. Validate all exported fields are accounted for (inline, json_columns, exclude, or auto-mapped)
4. Topologically sort tables by FK dependencies
5. Emit `schema.sql` and `query.sql` to the SQL output directory (`internal/db/` by default)
6. Emit `tables.go` (unexported constants + `creates` slice) and `insert.go` (type → `db.InsertXParams` mapping) to the output directory

### Key design decisions

- **Reflection-based**: `cmd/gensql` imports `pkgspec` and uses `reflect.TypeOf` to walk struct fields. Struct tags are directly accessible.
- **Fail-on-unknown-field**: If a struct field isn't in `inline`, `json_columns`, `exclude`, or auto-mapped, the generator errors. This ensures schema stays in sync with types.
- **Comments inside CREATE TABLE body**: All documentation goes inside `(...)` so `sqlite_master.sql` preserves them — making the database file self-documenting.
- **Processor as special case**: `Processor` has no standard struct tags; its table is defined via `extra_columns` only.
- **No SQLite driver in pkgsql**: Only `database/sql`. Tests use `modernc.org/sqlite`.
- **Internal db subpackage**: sqlc-generated types (`Queries`, `DBTX`, `InsertXParams` structs) live in `pkgsql/internal/db/` so the public API surface is just `WritePackages`, `WritePackage`, `TableSchemas`, `Option`, `WithECSLookup`, `WithDocContent`, `DocReader`, `OSDocReader`, and `RebuildDocsFTS`. The `api.go` file imports internal/db with a `dbpkg` alias to avoid shadowing the `db *sql.DB` parameter name.
- **FTS5 full-text search**: The `docs` table stores doc file paths and optional markdown content. A companion `docs_fts` FTS5 virtual table (external content mode, porter stemming) provides full-text search. `WritePackages` rebuilds the index automatically; callers using `WritePackage` directly must call `RebuildDocsFTS`. The FTS5 schema is hand-written in `fts.go` since the code generator cannot produce `CREATE VIRTUAL TABLE` syntax.
- **WithDocContent callback**: The `DocReader` callback pattern lets callers control how doc content is read. `OSDocReader` is the production convenience function. Tests can close over `fstest.MapFS` instead.

### Adding a new table

1. Add the entry to `cmd/gensql/tables.yml`
2. If the Go type isn't in the registry, add it to `cmd/gensql/internal/sqlgen/registry.go`
3. Run `go generate ./pkgsql/`
4. Add insertion logic to `pkgsql/api.go` in the appropriate `writeX` function

## Package structure (from package-spec, excluding _dev/)

### Integration package

```
manifest.yml                                      required  schema:integration/manifest.spec.yml
changelog.yml                                     required  schema:integration/changelog.spec.yml
validation.yml                                    optional  schema:integration/validation.spec.yml
NOTICE.txt                                        optional  plain text
LICENSE.txt                                       optional  plain text
docs/                                             required
  README.md                                       required  markdown (usually generated)
  *.md                                            optional  markdown
  knowledge_base/*.md                             optional  markdown (AI assistant context)
img/                                              optional  images (additionalContents: true)
agent/                                            optional
  input/stream/*.yml.hbs                          required  Handlebars templates
kibana/                                           optional
  tags.yml                                        optional  schema:integration/kibana/tags.spec.yml
  dashboard/*.json                                optional  opaque JSON saved objects
  visualization/*.json                            optional  "
  search/*.json                                   optional  "
  map/*.json                                      optional  "
  lens/*.json                                     optional  "
  index_pattern/*.json                            optional  "
  security_rule/*.json                            optional  "
  csp_rule_template/*.json                        optional  "
  ml_module/*.json                                optional  "
  tag/*.json                                      optional  "
  osquery_pack_asset/*.json                       optional  "
  osquery_saved_query/*.json                      optional  "
  alerting_rule_template/*.json                   optional  "
  slo_template/*.json                             optional  "
elasticsearch/                                    optional
  ingest_pipeline/*.yml|*.json                    optional  schema:integration/elasticsearch/pipeline.spec.yml
  ml_model/{PKG_NAME}_*.json                      optional  opaque JSON
  transform/<name>/                               optional
    transform.yml                                 required  schema:elasticsearch/transform/transform.spec.yml
    manifest.yml                                  optional  schema:elasticsearch/transform/manifest.spec.yml
    fields/*.yml                                  optional  schema:data_stream/fields/fields.spec.yml
  esql_view/*.yml                                 optional  schema:elasticsearch/view.spec.yml (3.6.0+)
_dev/test/config.yml                              optional  schema:integration/_dev/test/config.spec.yml
data_stream/<name>/                               optional
  manifest.yml                                    required  schema:data_stream/manifest.spec.yml
  fields/*.yml                                    required  schema:data_stream/fields/fields.spec.yml
  sample_event.json                               optional  opaque JSON
  routing_rules.yml                               optional  schema:data_stream/routing_rules.spec.yml (tech preview)
  lifecycle.yml                                   optional  schema:data_stream/lifecycle.spec.yml (tech preview)
  agent/stream/*.yml.hbs                          optional  Handlebars templates
  _dev/test/                                      optional  (loaded with WithTestConfigs)
    pipeline/test-*.json|*.log                    optional  pipeline test event files
    pipeline/test-*-config.yml                    optional  pipeline test per-case config
    pipeline/test-common-config.yml               optional  pipeline shared config
    system/test-*-config.yml                      optional  system test config
    static/test-*-config.yml                      optional  static test config
    policy/test-*.yml                             optional  policy test config
  elasticsearch/
    ingest_pipeline/*.yml|*.json                   optional  schema:elasticsearch/pipeline.spec.yml
    ilm/*.yml|*.json                               optional  opaque YAML/JSON
```

### Input package

```
manifest.yml                                      required  schema:input/manifest.spec.yml
changelog.yml                                     required  schema:integration/changelog.spec.yml
LICENSE.txt                                       optional  plain text
validation.yml                                    optional  schema:integration/validation.spec.yml
lifecycle.yml                                     optional  schema:data_stream/lifecycle.spec.yml (tech preview)
sample_event.json                                 optional  opaque JSON
agent/                                            required
  input/*.yml.hbs                                 required  Handlebars templates
docs/                                             required
  README.md                                       required  markdown
  *.md                                            optional  markdown
  knowledge_base/*.md                             optional  markdown
fields/*.yml                                      optional  schema:data_stream/fields/fields.spec.yml
img/                                              optional  images
_dev/test/config.yml                              optional  schema:input/_dev/test/config.spec.yml
_dev/test/system/test-*-config.yml                optional  system test config (loaded with WithTestConfigs)
_dev/test/policy/test-*.yml                       optional  policy test config (loaded with WithTestConfigs)
```

### Content package

```
manifest.yml                                      required  schema:content/manifest.spec.yml
changelog.yml                                     required  schema:integration/changelog.spec.yml
LICENSE.txt                                       optional  plain text
validation.yml                                    optional  schema:integration/validation.spec.yml
docs/                                             required
  README.md                                       required  markdown
  *.md                                            optional  markdown
  knowledge_base/*.md                             optional  markdown
img/                                              optional  images
kibana/                                           optional
  tags.yml                                        optional  schema:integration/kibana/tags.spec.yml
  dashboard/*.json                                optional  opaque JSON saved objects
  security_ai_prompt/*.json                       optional  "
  security_rule/*.json                            optional  "
  alerting_rule_template/*.json                   optional  "
  slo_template/*.json                             optional  "
elasticsearch/                                    optional
  esql_view/*.yml                                 optional  schema:elasticsearch/view.spec.yml (3.6.0+)
```

## Package reader (pkgreader)

- Uses `io/fs.FS` for filesystem abstraction (testable with `fstest.MapFS`)
- Detects package type from `manifest.yml` `type` field
- Options: `WithFS()`, `WithKnownFields()`, `WithGitMetadata()`, `WithTestConfigs()`
- `Package.Manifest()` returns the common `*pkgspec.Manifest` for any package type
- `Package.Docs` lists doc files from `docs/` (always populated, no option needed). Each `DocFile` has a `ContentType` (`readme`, `doc`, or `knowledge_base`) and `Path()`.
- Transform and pipeline files always decoded with `knownFields=false` (contain arbitrary ES DSL)
- Ingest pipelines loaded from `data_stream/<name>/elasticsearch/ingest_pipeline/*.yml`
- Git operations require real filesystem path (shell out to `git`)

## Testing

```sh
go test ./...                                                    # unit tests
INTEGRATIONS_DIR=/path/to/integrations go test ./pkgreader/ -run TestReadAllPackages  # all real packages
```

- Generator tests: schema loading, type mapping, augmentation, naming
- pkgspec tests: YAML unmarshaling with real 1password package (skipped if unavailable)
- pkgreader tests: synthetic testdata packages + optional integration test against all real packages
- pkgsql tests: round-trip insert + query using `modernc.org/sqlite` in-memory DB, verifies sqlite_master comments, FTS5 search

## Go practices

- Never use `github.com/stretchr/testify`
- Add conventional Go doc comments to all exported types, functions, and methods
- Format with `gofumpt -extra`
- Use `path.Join` (not `filepath.Join`) inside pkgreader for `fs.FS` compatibility (forward slashes)
- Avoid import aliases unless necessary to avoid conflicts.
